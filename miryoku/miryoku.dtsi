// Copyright 2022 Manna Harbour
// https://github.com/manna-harbour/miryoku

#include <behaviors.dtsi>
#include <behaviors/mouse_keys.dtsi>
#include <dt-bindings/zmk/keys.h>
#include <dt-bindings/zmk/bt.h>
#include <dt-bindings/zmk/rgb.h>
#include <dt-bindings/zmk/outputs.h>
#include <dt-bindings/zmk/ext_power.h>

#include "miryoku.h"

#include <dt-bindings/zmk/pointing.h>

/ {
  macros {
    u_macro_acircum: u_macro_acircum {
      compatible = "zmk,behavior-macro";
      #binding-cells = <0>;
      bindings = <&kp RA(N6) &kp A>;
    };
    u_macro_ecircum: u_macro_ecircum {
      compatible = "zmk,behavior-macro";
      #binding-cells = <0>;
      bindings = <&kp RA(N6) &kp E>;
    };
  };
  behaviors {
    u_td_esc_baselayer: u_td_esc_baselayer {
      compatible = "zmk,behavior-tap-dance";
      #binding-cells = <0>;
      #tapping-term-ms = <U_TAPPING_TERM>;
      bindings = <&kp ESC>, <&to U_BASE>;
    };

    u_td_altr_a: u_td_altr_a {
      compatible = "zmk,behavior-tap-dance";
      #binding-cells = <0>;
      #tapping-term-ms = <U_TAPPING_TERM>;
      bindings = <&kp RA(A)>, <&u_macro_acircum>;
    };
    u_td_altr_sft_a: u_td_altr_sft_a {
      compatible = "zmk,behavior-tap-dance";
      #binding-cells = <0>;
      #tapping-term-ms = <U_TAPPING_TERM>;
      bindings = <&kp LS(RA(A))>, <&u_macro_acircum>;
    };
    u_ra_sft_a: u_ra_sft_a {
      compatible = "zmk,behavior-mod-morph";
      #binding-cells = <0>;
      bindings = <&u_td_altr_a>, <&u_td_altr_sft_a>;
      mods = <(MOD_LSFT|MOD_RSFT)>;
      //keep-mods = <(MOD_LSFT|MOD_RSFT)>;
    };
    //a macro U_MT nao estah definida aqui entao vamos usar &u_mt direto porem isto ignora evenhtual define MIRYOKU_KLUDGE_TAPDELAY
    u_ra_a: u_ra_a {
      compatible = "zmk,behavior-mod-morph";
      #binding-cells = <0>;
      bindings = <&u_mt LGUI A>, <&u_ra_sft_a>;
      mods = <(MOD_RALT)>;
    };

    u_td_altr_e: u_td_altr_e {
      compatible = "zmk,behavior-tap-dance";
      #binding-cells = <0>;
      #tapping-term-ms = <U_TAPPING_TERM>;
      bindings = <&kp RA(E)>, <&u_macro_ecircum>;
    };
    u_td_altr_sft_e: u_td_altr_sft_e {
      compatible = "zmk,behavior-tap-dance";
      #binding-cells = <0>;
      #tapping-term-ms = <U_TAPPING_TERM>;
      bindings = <&kp LS(RA(E))>, <&u_macro_ecircum>;
    };
    u_ra_sft_e: u_ra_sft_e {
      compatible = "zmk,behavior-mod-morph";
      #binding-cells = <0>;
      bindings = <&u_td_altr_e>, <&u_td_altr_sft_e>;
      mods = <(MOD_LSFT|MOD_RSFT)>;
      keep-mods = <(MOD_LSFT|MOD_RSFT)>;
    };
    u_ra_e: u_ra_e {
      compatible = "zmk,behavior-mod-morph";
      #binding-cells = <0>;
      bindings = <&kp E>, <&u_ra_sft_e>;
      mods = <(MOD_RALT)>;
    };

  };

  keymap {
    compatible = "zmk,keymap";
#define MIRYOKU_X(LAYER, STRING) \
    LAYER { \
      display-name = STRING; \
      bindings = < U_MACRO_VA_ARGS(MIRYOKU_LAYERMAPPING_##LAYER, MIRYOKU_LAYER_##LAYER) >; \
    };
MIRYOKU_LAYER_LIST
#undef MIRYOKU_X
  };
};

#include "miryoku_shift_functions.dtsi"

#include "miryoku_double_tap_guard.dtsi"

#include "miryoku_mousekeys.dtsi"

#if defined (MIRYOKU_KLUDGE_THUMBCOMBOS)
  #include "miryoku_kludge_thumbcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_TOPROWCOMBOS)
  #include "miryoku_kludge_toprowcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_BOTTOMROWCOMBOS)
  #include "miryoku_kludge_bottomrowcombos.dtsi"
#endif

#if defined (MIRYOKU_KLUDGE_TAPDELAY)
  #include "miryoku_kludge_tapdelay.dtsi"
#else
  #include "miryoku_behaviors.dtsi"
#endif

